# Repository Guidelines

## Project Structure & Module Organization

- `src/`: Library source (TypeScript). Core in `src/core/`, helpers in `src/utils/`, presets in `src/presets/`, shared types in `src/types/`.
- `tests/`: Jest tests. Unit in `tests/utils/`, `tests/core/`, `tests/presets/`; integration in `tests/integration/`; performance in `tests/performance/`.
- `dist/`: Build artifacts (ESM/CJS and types) generated by `tsup` — do not edit by hand.
- Aliases: import via `@/…` mapped to `src/` (see `tsconfig.json`).

## Build, Test, and Development Commands

- Install: `pnpm install` (Node >= 18).
- Lint: `pnpm lint` — ESLint + Prettier plugin; fix warnings/errors. Complexity ≤ 7.
- Build: `pnpm build` — bundles with `tsup` to ESM/CJS and emits `.d.ts`.
- Test (all unit): `pnpm test` or `pnpm run test:unit`.
- Test (performance): `pnpm run test:performance`.
- Example targeted run: `pnpm test -- tests/utils/array.test.ts`.
- Before pushing: run `pnpm lint && pnpm test && pnpm build`.

- With `mise` (optional): `mise install` to fetch Node/pnpm, then `mise run qa` (lint+test+build). Other tasks: `mise run lint|build|test|test_unit|test_performance`.

## Coding Style & Naming Conventions

- Language: TypeScript (`strict: true`). Prefer `readonly` arrays for inputs.
- Files: kebab-case (e.g., `divider-first.ts`), types/interfaces PascalCase, functions camelCase, constants UPPER_SNAKE_CASE where appropriate.
- Formatting: Prettier 3 via ESLint. Use 2-space indent, single quotes, trailing commas where valid.
- Immutability: avoid mutating parameters; prefer `readonly` data and pure helpers.
- Constants: avoid magic numbers; extract and reuse via `src/constants/` when sensible.
- Comments: explain "why" design decisions, not obvious "what".
- Structure: Keep pure helpers in `src/utils/`; limit function complexity (≤ 7) and avoid unused exports.

## Testing Guidelines

- Framework: Jest with `ts-jest` preset, Node environment.
- Names: unit tests `*.test.ts`; performance tests `*.performance.test.ts`.
- Location: place tests mirroring module path under `tests/` (e.g., `src/utils/array.ts` → `tests/utils/array.test.ts`).
- Style: write BDD-style descriptions; structure with AAA (Arrange-Act-Assert).
- Coverage focus: normal, edge (empty strings/arrays), and error cases; include quoted/escaped and irregular separator scenarios.

## Commit & Pull Request Guidelines

- Commits: follow Conventional Commits (e.g., `feat:`, `fix:`, `refactor:`, `test:`, `docs:`, `chore:`). Example: `fix: pathDivider export`.
- PRs: include a clear description, linked issue (if any), and note behavior changes. Attach before/after or small examples when touching parsing.
- Quality gate: ensure clean lint/test/build locally. Do not bump versions or edit `dist/`; releases are automated.

## Development Policy

- Language: TypeScript only; use strict, explicit types.
- Linting: follow project ESLint config; aim for zero warnings locally.
- Reference: full specifications live in `README.md` and `src/presets/README.md`.

## Security & Configuration Tips

- No secrets required; avoid committing credentials. Respect `.gitignore` and ESLint ignores for `dist/` and `docs/`.
- Prefer imports via `@/…` to keep paths stable when moving files.

## Documentation & Comments

- Purpose: Add JSDoc to public APIs and WHY comments to non-obvious implementations. Leave enough intent so future readers don’t have to guess.
- JSDoc: One-line summary + `@param` / `@returns` by default. Use `@example` only for broadly useful or commonly misused functions (optional). Do not use `@typeParam`.
- WHY comments: Explain “why this design/implementation” briefly. Capture performance, compatibility, background, or constraints that are not obvious from code. Place directly above the target code.
- Style: Concise, active voice, consistent terminology. Don’t restate information that TypeScript types already make obvious.

Example — logic combinator (public JSDoc):

```ts
/**
 * Combines a precondition guard with an additional refinement to narrow the type.
 * @param precondition Broad guard evaluated first; short-circuits on failure.
 * @param condition Refinement evaluated only when `precondition` passes.
 * @returns Predicate that narrows the input to a subtype.
 * // @example: include only if this utility is widely used or often misused
 */
export function and<A, B extends A>(
  precondition: Guard<A>,
  condition: Refine<A, B>
): (x: unknown) => x is B {
  /* ... */
}
```

Example — WHY comment (performance/semantics):

```ts
// WHY: For small literal sets, a linear scan with Object.is preserves exact
// equality semantics (NaN, +0/-0) without Set overhead. For larger sets,
// switch to Set membership for speed.
const ONE_OF_VALUES_LINEAR_SCAN_MAX = 8;
```

### Intent/Background (Why)

Capture the reason this exists. If there’s time-bound context or deprecation intent, say so.

```ts
/**
 * Get congested time slots for the expo.
 * Background: Implemented for the 2025 Osaka Expo; scheduled for removal later.
 */
const getExpoCongestedTime = (targetDate: Date): Promise<Time[]> => {
  // ...
  return congestedTimeList;
};
```

### Contract (JSDoc/TSDoc)

Document the interface of the function with `@param` / `@returns`. Add `@example` when it materially helps.

```ts
/**
 * Get congested time slots for the expo.
 * Background: Implemented for the 2025 Osaka Expo; scheduled for removal later.
 * @param targetDate Target date to retrieve congested time windows for.
 * @returns Array of congested time windows.
 */
const getExpoCongestedTime = (targetDate: Date): Promise<Time[]> => {
  /* ... */
};
```

### Tagged comments

- TODO: Work planned for later
- FIXME: Known issue or temporary workaround
- HACK: Necessary but non-ideal code
- NOTE: Design rationale or reference info

```ts
/**
 * Get congested time slots for the expo.
 * Background: Implemented for the 2025 Osaka Expo.
 * TODO: Remove after the event ends.
 * @param targetDate Target date to retrieve congested time windows for.
 * @returns Array of congested time windows.
 */
```

### Directive comments

When using `eslint-disable` or `@ts-ignore`, always include a neighboring WHY comment explaining the suppression.

```ts
// HACK: Accept any due to unknown legacy type surface; tracked in issue #123.
// eslint-disable-next-line @typescript-eslint/no-explicit-any
function handleLegacyData(data: any) {
  // @ts-ignore: Third-party typings are outdated; safe in our usage context.
  someLegacyLibrary.doSomething(data);
}
```

### Reference links

Link issues/PRs/specs with `@see` so readers can follow the context.

```ts
/**
 * Task executed during build.
 * Used to address the following issue.
 * @see https://github.com/your-org/your-repo/issues/123
 */
```

Scope guidelines:

- Public exports: Always include JSDoc, and add WHY where non-obvious.
- Internal utilities: Add brief JSDoc/WHY when used across modules or when behavior is tricky.
- Avoid trivial inline comments; concentrate where they prevent misunderstandings or regressions.

Note: See `.github/prompts/jsdoc.prompt.md` for additional tone/phrasing inspiration.
